
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>asynchat &#8211; 非同期プロトコルハンドラ - Python Module of the Week</title>

<link rel="stylesheet" href="../_static/default.css" 
    type="text/css" />
<style>
    body {
        margin: 8px;
    }
    .highlight {
        background-color: white;
        border: 0;
    }
    .highlight pre {
        background-color: white;
    }
</style>

<link href="../_static/css/leaves.css" rel="stylesheet" type="text/css" />
<link rel="alternate" type="application/atom+xml"
      title="Doug Hellmann"
      href="http://feeds.feedburner.com/DougHellmann" />
<link rel="alternate" type="application/atom+xml"
      title="Doug Hellmann Project Releases"
      href="http://feeds.feedburner.com/DougHellmann-Releases" />
<link rel="alternate" type="application/atom+xml"
      title="Doug Hellmann Links"
      href="http://feeds.feedburner.com/DougHellmannLinkBlog" />



<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
      URL_ROOT:    '../',
      VERSION:     '1.132',
      COLLAPSE_MODINDEX: false,
      FILE_SUFFIX: '.html'
  };
</script>

<script type="text/javascript" src="../_static/jquery.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="contents" title="コンテンツテーブル" href="../contents.html" />
    <link rel="index" title="インデックス" href="../genindex.html" />
    <link rel="top" title="Python Module of the Week" href="../index.html" />
    <link rel="up" title="プロセス間通信とネットワーキング" href="../ipc.html" />
    <link rel="next" title="asyncore – 非同期 I/O ハンドラ" href="../asyncore/index.html" />
    <link rel="prev" title="プロセス間通信とネットワーキング" href="../ipc.html" />

<meta name="verify-v1" content="5saTcOa2HLac4V85yUg3SARfun1PqT5Upu7IR/6fpv4="/>
</head>
<body>
    
<div id="container">
    
<div id="header">
  <a href="/"><h1>PyMOTW</h1></a>
  <p></p>
</div>

<div id="sidebar_left_wrapper">

<div id="navigation"> 
	<ul id="navlist">
		<li><a href="../index.html">ホーム</a></li>
		<li><a href="http://blog.doughellmann.com/" target="_">ブログ</a></li>
        <li><a href="http://www.doughellmann.com/books/">書籍</a></li>
		<li><a href="../about.html">自己紹介</a></li>
		<li><a href="/2/genindex.html">サイトインデックス</a></li>
	</ul>
</div>


  <div id="sidebar_left">
      <p>この情報が役に立つと思われたら、私の本を手に取ってみてください。
      <i><a href="/books/byexample/">The Python Standard Library By
      Example</a></i>.</p>
  </div>

</div>


<div id="sidebar">
  <h3>ページコンテンツ</h3>
  <ul>
<li><a class="reference internal" href="#">asynchat &#8211; 非同期プロトコルハンドラ</a><ul>
<li><a class="reference internal" href="#id1">メッセージターミネイタ</a></li>
<li><a class="reference internal" href="#id2">サーバとハンドラ</a></li>
<li><a class="reference internal" href="#id3">クライアント</a></li>
<li><a class="reference internal" href="#id4">全てひとつにまとめる</a></li>
</ul>
</li>
</ul>
    <h3>ナビゲーション</h3>
      <p>
    <a href="../contents.html"><strong>コンテンツテーブル</strong></a><br/>
    
          <a href="../ipc.html" title="前の章へ"><strong>前:</strong> プロセス間通信とネットワーキング</a><br/>
          <a href="../asyncore/index.html" title="次の章へ"><strong>次:</strong> asyncore &#8211; 非同期 I/O ハンドラ</a><br/>
      </p>
    
      <h3>This Page</h3>
      <p>
      <a href="../_sources/asynchat/index.txt"
               rel="nofollow">Show Source</a>
      </p><h3>サンプルプログラム</h3>

<p>PyMOTW の全てのサンプルプログラムの出力は、
注記されていない限りは Python 2.7.2 で生成されています。
標準ライブラリの初期のバージョンでは利用できない機能も紹介している
可能性があります。</p><p><iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=DDDDDD&fc1=000000&lc1=CC6714&t=hellflynet-20&o=1&p=8&l=as1&m=amazon&f=ifr&md=10FE9736YVPPT7A0FBG2&asins=0321767349" style="width:120px;height:240px;margin:0 1em 0 1em;" scrolling="no" frameborder="0"></iframe></p>    <p class="ads">
    <script type="text/javascript"><!--
    google_ad_client = "pub-3205160560229413";
    google_ad_width = 120;
    google_ad_height = 600;
    google_ad_format = "120x600_as";
    google_ad_type = "text";
    //2007-10-27: www.doughellmann.com
    google_ad_channel = "0828653884";
    google_color_border = "FFFFFF";
    google_color_bg = "FFFFFF";
    google_color_link = "CC6714";
    google_color_text = "000000";
    google_color_url = "999999";
    google_ui_features = "rc:0";
    //-->
    </script>
    <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
    </script>
    </p>
</div>


<div id="content">

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../asyncore/index.html" title="asyncore – 非同期 I/O ハンドラ"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../ipc.html" title="プロセス間通信とネットワーキング"
             accesskey="P">previous</a> |</li>
        <li><a href="../contents.html">PyMOTW</a> &raquo;</li>
          <li><a href="../ipc.html" accesskey="U">プロセス間通信とネットワーキング</a> &raquo;</li> 
      </ul>
    </div>

  <div class="section" id="asynchat">
<h1>asynchat &#8211; 非同期プロトコルハンドラ<a class="headerlink" href="#asynchat" title="Permalink to this headline">¶</a></h1>
<span class="target" id="module-asynchat"></span><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">目的:</th><td class="field-body">非同期ネットワーク通信プロトコルハンドラ</td>
</tr>
<tr class="field"><th class="field-name">利用できるバージョン:</th><td class="field-body">1.5.2 以上</td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="#module-asynchat" title="非同期プロトコルハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asynchat</span></tt></a> モジュールは <a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a> 上で構築されるサーバクライアント間でメッセージのやり取りに基づいたプロトコルを簡単に実装します。 <tt class="xref py py-class docutils literal"><span class="pre">async_chat</span></tt> クラスは、データを受け取り、メッセージターミネイタを探す <tt class="xref py py-class docutils literal"><span class="pre">asyncore.dispatcher</span></tt> のサブクラスです。そのサブクラスは、データを受け取ったときに何をするかと、ターミネイタを見つけたときにどう応答するかの2つのみ指定する必要があります。送信するデータは <tt class="xref py py-class docutils literal"><span class="pre">async_chat</span></tt> が管理する FIFO オブジェクトを経由して転送キューに追加されます。</p>
<div class="section" id="id1">
<h2>メッセージターミネイタ<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>受け取ったメッセージは <em>ターミネイタ</em> に基づいて分割されて、 <tt class="xref py py-func docutils literal"><span class="pre">set_terminator()</span></tt> を通してそれぞれのインスタンスで管理されます。設定方法は3つあります。</p>
<ol class="arabic simple">
<li><tt class="xref py py-func docutils literal"><span class="pre">set_terminator()</span></tt> に文字列の引数が渡された場合、入力データにその文字列が現れたときにメッセージが完了したと見なされます。</li>
</ol>
<ol class="arabic simple" start="2">
<li>数値の引数が渡された場合、そのバイト数を読み込んだときにメッセージが完了したと見なされます。</li>
</ol>
<ol class="arabic simple" start="3">
<li><tt class="xref docutils literal"><span class="pre">None</span></tt> が渡された場合、 <tt class="xref py py-class docutils literal"><span class="pre">async_chat</span></tt> はメッセージの完了を管理しません。</li>
</ol>
<p>次の <tt class="xref py py-class docutils literal"><span class="pre">EchoServer</span></tt> サンプルは、入力データのコンテキストに依存するシンプルな文字列ターミネイタとメッセージ長ターミネイタの2つを使用します。標準ライブラリドキュメントにある HTTP リクエストハンドラのサンプルは、HTTP ヘッダと HTTP POST リクエストの本文の間で異なるコンテキストに基づいてターミネイタを変更する方法を紹介します。</p>
</div>
<div class="section" id="id2">
<h2>サーバとハンドラ<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#module-asynchat" title="非同期プロトコルハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asynchat</span></tt></a> と <a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a> の違いを簡単に説明するために、 <a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a> の記事から同じ <tt class="xref py py-class docutils literal"><span class="pre">EchoServer</span></tt> サンプルを紹介します。サーバオブジェクトはコネクションを受け付ける、ハンドラオブジェクトはそれぞれのクライアントとの通信を扱う、クライアントオブジェクトは通信を開始するといった同じ役割を担います。</p>
<p><a class="reference internal" href="#module-asynchat" title="非同期プロトコルハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asynchat</span></tt></a> で動作する <tt class="xref py py-class docutils literal"><span class="pre">EchoServer</span></tt> は、今回はあまり関係ない <a class="reference internal" href="../logging/index.html#module-logging" title="ステータス、エラー、その他の情報をログ出力する"><tt class="xref py py-mod docutils literal"><span class="pre">logging</span></tt></a> の呼び出す回数を少なくして、 <a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a> のサンプルと同様に同じオブジェクトを作成します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">asynchat_echo_handler</span> <span class="kn">import</span> <span class="n">EchoHandler</span>

<span class="k">class</span> <span class="nc">EchoServer</span><span class="p">(</span><span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Receives connections and establishes handlers for each client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">handle_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># クライアントがソケットへ接続したときに呼び出される</span>
        <span class="n">client_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">EchoHandler</span><span class="p">(</span><span class="n">sock</span><span class="o">=</span><span class="n">client_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c"># 一度に一クライアントのみを扱うのでハンドラを設定したらクローズする</span>
        <span class="c"># 普通はクローズせずにサーバは停止命令を受け取るか、永遠に実行される</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_close</span><span class="p">()</span>
        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">handle_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>このサンプルは <tt class="xref py py-class docutils literal"><span class="pre">asyncore.dispatcher</span></tt> ではなく <tt class="docutils literal"><span class="pre">asynchat.async_chat</span></tt> をベースクラスとする <tt class="xref py py-class docutils literal"><span class="pre">EchoHandler</span></tt> です。それはわずかに高レベルの抽象化を行って操作するので、読み書きは自動的に扱われます。そのバッファは次の4つを知っている必要があります。</p>
<ul class="simple">
<li>(<tt class="xref py py-func docutils literal"><span class="pre">handle_incoming_data()</span></tt> をオーバーライドすることで) 入力データで何をするか</li>
<li>(<tt class="xref py py-func docutils literal"><span class="pre">set_terminator()</span></tt> 経由の) 入力メッセージの終わりをどうやって認識するか</li>
<li>(<tt class="xref py py-func docutils literal"><span class="pre">found_terminator()</span></tt> で) メッセージが完了したときに何をするか</li>
<li>(<tt class="xref py py-func docutils literal"><span class="pre">push()</span></tt> を使用して) 何を送信するか</li>
</ul>
<p>サンプルアプリケーションは2つの操作モードがあります。1つは <tt class="docutils literal"><span class="pre">ECHO</span> <span class="pre">length\n</span></tt> フォームのコマンドを待つか、もう1つは送り返されるデータを待つかです。このモードは、ターミネイタが見つかった後で必要に応じてターミネイタを変更するときに、実行されるメソッドに対するインスタンス変数 <em>process_data</em> の設定によって交互に変わります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">asynchat</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="k">class</span> <span class="nc">EchoHandler</span><span class="p">(</span><span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles echoing messages from a single client.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># 並列にメッセージを送受信するのを説明するために</span>
    <span class="c"># 人為的にバッファサイズを減少させる</span>
    <span class="n">ac_in_buffer_size</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">ac_out_buffer_size</span> <span class="o">=</span> <span class="mi">64</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;EchoHandler&#39;</span><span class="p">)</span>
        <span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span>
        <span class="c"># ECHO コマンドを探すのを開始する</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_terminator</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">collect_incoming_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read an incoming message from the client and put it into our outgoing queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;collect_incoming_data() -&gt; (</span><span class="si">%d</span><span class="s"> bytes)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">found_terminator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The end of a command or message has been seen.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;found_terminator()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_data</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_process_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;We have the full ECHO command&quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">received_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_process_command() &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="n">command_verb</span><span class="p">,</span> <span class="n">command_arg</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">expected_data_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">command_arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_terminator</span><span class="p">(</span><span class="n">expected_data_len</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">_process_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We have read the entire message to be sent back to the client&quot;&quot;&quot;</span>
        <span class="n">to_echo</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">received_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_process_message() echoing</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="n">to_echo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">to_echo</span><span class="p">)</span>
        <span class="c"># 一度に一つだけ処理するので応答を送信した後で切断する</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_when_done</span><span class="p">()</span>
</pre></div>
</div>
<p>完了コマンドが見つかると、ハンドラはメッセージ処理モードを切り替えて、テキストセット全体を受信するのを待ちます。全てのデータを受信すると、送信チャンネルへ追加されて、そのデータを送信したら閉じるようにハンドラを設定します。</p>
</div>
<div class="section" id="id3">
<h2>クライアント<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>クライアントは、ほとんどハンドラと同様に動作します。 <a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a> の実装と同様に、その送信メッセージはクライアントのコンストラクタへの引数です。ソケットのコネクションが確立されると、 <tt class="xref py py-func docutils literal"><span class="pre">handle_connect()</span></tt> が呼び出されるので、クライアントはコマンドとメッセージデータを送れます。</p>
<p>そのコマンドは直接追加されますが、メッセージテキストには特別な &#8220;producer&#8221; クラスを使用します。producer は、ネットワーク上で送信するためにデータのチャンクをポーリングします。producer が空文字を返すとき、それはデータがなくなり、停止を書き込んだと想定します。</p>
<p>クライアントは、応答のメッセージデータをただ待ち続けるので、整数ターミネイタを設定して、メッセージ全体を受信するまでリストにデータを追加します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">asynchat</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>


<span class="k">class</span> <span class="nc">EchoClient</span><span class="p">(</span><span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends messages to the server and receives responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># 並列にメッセージを送受信するのを説明するために</span>
    <span class="c"># 人為的にバッファサイズを減少させる</span>
    <span class="n">ac_in_buffer_size</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">ac_out_buffer_size</span> <span class="o">=</span> <span class="mi">64</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;EchoClient&#39;</span><span class="p">)</span>
        <span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;connecting to </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="k">return</span>
        
    <span class="k">def</span> <span class="nf">handle_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;handle_connect()&#39;</span><span class="p">)</span>
        <span class="c"># コマンドを送る</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s">&#39;ECHO </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
        <span class="c"># データを送る</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_with_producer</span><span class="p">(</span><span class="n">EchoProducer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ac_out_buffer_size</span><span class="p">))</span>
        <span class="c"># データがそのまま送り返されるはずなのでデータ長をターミネイタにセットする</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_terminator</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">collect_incoming_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read an incoming message from the client and put it into our outgoing queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;collect_incoming_data() -&gt; (</span><span class="si">%d</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">found_terminator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;found_terminator()&#39;</span><span class="p">)</span>
        <span class="n">received_message</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">received_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">received_message</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;RECEIVED COPY OF MESSAGE&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;ERROR IN TRANSMISSION&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;EXPECTED &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;RECEIVED &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="n">received_message</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">class</span> <span class="nc">EchoProducer</span><span class="p">(</span><span class="n">asynchat</span><span class="o">.</span><span class="n">simple_producer</span><span class="p">):</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;EchoProducer&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">more</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">asynchat</span><span class="o">.</span><span class="n">simple_producer</span><span class="o">.</span><span class="n">more</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;more() -&gt; (</span><span class="si">%s</span><span class="s"> bytes)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>全てひとつにまとめる<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>このサンプルのメインプログラムは、同じ <a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a> メインループ内にクライアントとサーバを設定します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">asynchat_echo_server</span> <span class="kn">import</span> <span class="n">EchoServer</span>
<span class="kn">from</span> <span class="nn">asynchat_echo_client</span> <span class="kn">import</span> <span class="n">EchoClient</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(name)s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># カーネルにポート番号を割り当てさせる</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">EchoServer</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">address</span> <span class="c"># 与えられたポート番号を調べる</span>

<span class="n">message_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;lorem.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">EchoClient</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message_data</span><span class="p">)</span>

<span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</pre></div>
</div>
<p>普通は、独立したプロセスでクライアントやサーバを実行しますが、こうすることで簡単にログ出力を組み合わせて表示できます。</p>
<div class="highlight-python"><pre>$ python asynchat_echo_main.py
EchoClient: connecting to ('127.0.0.1', 59601)
EchoClient: handle_connect()
EchoProducer: more() -&gt; (64 bytes)
"""Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Donec
"""
EchoHandler: collect_incoming_data() -&gt; (8 bytes)
"""ECHO 166"""
EchoHandler: found_terminator()
EchoHandler: _process_command() "ECHO 166"
EchoHandler: collect_incoming_data() -&gt; (55 bytes)
"""Lorem ipsum dolor sit amet, consectetuer adipiscing eli"""
EchoProducer: more() -&gt; (64 bytes)
"""egestas, enim et consectetuer ullamcorper, lectus ligula rutrum """
EchoHandler: collect_incoming_data() -&gt; (64 bytes)
"""t. Donec
egestas, enim et consectetuer ullamcorper, lectus ligul"""
EchoProducer: more() -&gt; (38 bytes)
"""leo, a
elementum elit tortor eu quam.
"""
EchoHandler: collect_incoming_data() -&gt; (47 bytes)
"""a rutrum leo, a
elementum elit tortor eu quam.
"""
EchoHandler: found_terminator()
EchoHandler: _process_message() echoing
"""Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Donec
egestas, enim et consectetuer ullamcorper, lectus ligula rutrum leo, a
elementum elit tortor eu quam.
"""
EchoProducer: more() -&gt; (0 bytes)
""""""
EchoClient: collect_incoming_data() -&gt; (64)
"""Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Donec
"""
EchoClient: collect_incoming_data() -&gt; (64)
"""egestas, enim et consectetuer ullamcorper, lectus ligula rutrum """
EchoClient: collect_incoming_data() -&gt; (38)
"""leo, a
elementum elit tortor eu quam.
"""
EchoClient: found_terminator()
EchoClient: RECEIVED COPY OF MESSAGE</pre>
</div>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="http://docs.python.org/library/asynchat.html">asynchat</a></dt>
<dd>本モジュールの標準ライブラリドキュメント</dd>
<dt><a class="reference internal" href="../asyncore/index.html#module-asyncore" title="非同期 I/O ハンドラ"><tt class="xref py py-mod docutils literal"><span class="pre">asyncore</span></tt></a></dt>
<dd>低レベルの非同期 I/O イベントループを実装する asyncore モジュール</dd>
</dl>
</div>
</div>
</div>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../asyncore/index.html" title="asyncore – 非同期 I/O ハンドラ"
             >next</a> |</li>
        <li class="right" >
          <a href="../ipc.html" title="プロセス間通信とネットワーキング"
             >previous</a> |</li>
        <li><a href="../contents.html">PyMOTW</a> &raquo;</li>
          <li><a href="../ipc.html" >プロセス間通信とネットワーキング</a> &raquo;</li> 
      </ul>
    </div>



<div id="addthis"><a href="http://www.addthis.com/bookmark.php" onclick="addthis_url   = location.href; addthis_title = document.title; return addthis_click(this);" target="_blank"><img src="http://s7.addthis.com/static/btn/lg-share-en.gif" width="125" height="16" border="0" alt="Bookmark and Share" /></a><script type="text/javascript">var addthis_pub = "dhellmann";</script><script type="text/javascript" src="http://s7.addthis.com/js/widget.php?v=10"></script></div>



<!-- Disqus -->
<div id="disqus_wrapper">
<div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/doughellmann/embed.js"></script><noscript><a href="http://doughellmann.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</div>

<div id="footer_ads">

    <p><script type="text/javascript"><!--
    google_ad_client = "pub-3205160560229413";
    google_ad_width = 728;
    google_ad_height = 90;
    google_ad_format = "728x90_as";
    google_ad_type = "text";
    //2007-10-21: www.doughellmann.com
    google_ad_channel = "9907726884";
    google_color_border = "FFFFFF";
    google_color_bg = "FFFFFF";
    google_color_link = "CC6714";
    google_color_text = "000000";
    google_color_url = "999999";
    google_ui_features = "rc:0";
    //-->
    </script>
    <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
    </script></p>
</div>

<div id="footer">
 
<p>
    &copy; Copyright Doug Hellmann.
    | <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/" rel="license"><img alt="Creative Commons License" style="border-width:0; align: center;" width="80" height="15" src="http://i.creativecommons.org/l/by-nc-sa/3.0/us/80x15.png"/></a>
    | Last updated on Feb 17, 2013.
   | Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
   | Design based on "Leaves" by <a href="http://smallpark.org">SmallPark</a>
</p>
   
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript" />
<script type="text/javascript">
  _uacct = "UA-1847381-1";
  urchinTracker();
</script>

</div>

</div>


<!-- Disqus -->
<script type="text/javascript">
//<![CDATA[
(function() {
		var links = document.getElementsByTagName('a');
		var query = '?';
		for(var i = 0; i < links.length; i++) {
			if(links[i].href.indexOf('#disqus_thread') >= 0) {
				query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
			}
		}
		document.write('<script type="text/javascript" src="http://disqus.com/forums/doughellmann/get_num_replies.js' + query + '"></' + 'script>');
	})();
//]]>
</script>


</body>
</html>